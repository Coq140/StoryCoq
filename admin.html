<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Gestion utilisateurs avancée</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 10px;}
    table {width: 100%; border-collapse: collapse; margin-top: 15px;}
    th, td {border: 1px solid #aaa; padding: 8px; text-align: left;}
    th {background-color: #ddd;}
    input[type="text"], select {width: 100%; padding: 5px; box-sizing: border-box;}
    button {margin-top: 10px; padding: 8px 12px; cursor: pointer; background: #0095f6; color: white; border: none; border-radius: 4px; font-weight: bold;}
    nav a {margin-right: 10px; text-decoration: none; font-weight: bold; color: #333;}
  </style>
</head>
<body>
  // Chargement utilisateurs et session
  
  let users = JSON.parse(localStorage.getItem('instaUsers')) || {};
  let currentUser = JSON.parse(localStorage.getItem('instaUser'));

  function redirectToIndex() {
    alert("Accès refusé : page admin réservée aux administrateurs.");
    window.location.href = "index.html";
  }

  // Restreindre page admin aux badge admin
  if (!currentUser || currentUser.badge !== "admin") {
    redirectToIndex();
  }

  function saveUsers() {
    localStorage.setItem('instaUsers', JSON.stringify(users));
  }

  function updateCurrentUserIfNeeded(username) {
    if (currentUser && currentUser.name === username) {
      currentUser = { name: username, ...users[username] };
      localStorage.setItem('instaUser', JSON.stringify(currentUser));
    }
  }

<header>
  <h1>Admin - Gestion des utilisateurs</h1>
  <nav>
    <a href="feed.html">Feed</a>
    <a href="profil.html">Profil</a>
    <a href="index.html" onclick="logout()">Déconnexion</a>
  </nav>
</header>

<div id="message"></div>

<table id="usersTable">
  <thead>
    <tr>
      <th>Nom d'utilisateur</th>
      <th>Badge</th>
      <th>Entreprise affiliée</th>
      <th>Bio</th>
      <th>Avatar URL</th>
      <th>Bannière URL</th>
      <th>Story</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Utilisateurs listés ici -->
  </tbody>
</table>

<script>

  // Construire tableau
  function buildTable() {
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    for (const username in users) {
      const user = users[username];
      const tr = document.createElement('tr');

      // Nom
      const tdName = document.createElement('td');
      tdName.textContent = username;
      tr.appendChild(tdName);

      // Badge
      const tdBadge = document.createElement('td');
      const selectBadge = document.createElement('select');
      const badges = ["", "certifié", "entreprise", "admin"];
      badges.forEach(b => {
        const option = document.createElement('option');
        option.value = b;
        option.textContent = b === "" ? "(aucun)" : b;
        if (user.badge === b) option.selected = true;
        selectBadge.appendChild(option);
      });
      tdBadge.appendChild(selectBadge);
      tr.appendChild(tdBadge);

      // Entreprise affiliée (seulement si badge entreprise)
      const tdEntreprise = document.createElement('td');
      const inputEntreprise = document.createElement('input');
      inputEntreprise.type = 'text';
      inputEntreprise.placeholder = "Nom compte entreprise affiliée";
      inputEntreprise.value = user.entrepriseAffiliee || "";
      if (user.badge !== "entreprise") {
        inputEntreprise.disabled = true;
        inputEntreprise.style.backgroundColor = "#eee";
      }
      tdEntreprise.appendChild(inputEntreprise);
      tr.appendChild(tdEntreprise);

      // Bio
      const tdBio = document.createElement('td');
      const inputBio = document.createElement('input');
      inputBio.type = 'text';
      inputBio.value = user.bio || "";
      tdBio.appendChild(inputBio);
      tr.appendChild(tdBio);

      // Avatar
      const tdAvatar = document.createElement('td');
      const inputAvatar = document.createElement('input');
      inputAvatar.type = 'text';
      inputAvatar.value = user.avatar || "";
      tdAvatar.appendChild(inputAvatar);
      tr.appendChild(tdAvatar);

      // Bannière
      const tdBanner = document.createElement('td');
      const inputBanner = document.createElement('input');
      inputBanner.type = 'text';
      inputBanner.value = user.banner || "";
      tdBanner.appendChild(inputBanner);
      tr.appendChild(tdBanner);

      // Story
      const tdStory = document.createElement('td');
      const inputStory = document.createElement('input');
      inputStory.type = 'text';
      inputStory.value = user.story || "";
      tdStory.appendChild(inputStory);
      tr.appendChild(tdStory);

      // Actions
      const tdActions = document.createElement('td');
      const btnSave = document.createElement('button');
      btnSave.textContent = "Sauvegarder";
      btnSave.onclick = () => {
        const badgeSelected = selectBadge.value;
        users[username].badge = badgeSelected;
        users[username].bio = inputBio.value.trim();
        users[username].avatar = inputAvatar.value.trim() || "default-avatar.png";
        users[username].banner = inputBanner.value.trim();
        users[username].story = inputStory.value.trim();

        // Gestion entreprise affiliée
        if (badgeSelected === "entreprise") {
          // Vérifier que le compte affilié existe
          const affilié = inputEntreprise.value.trim();
          if (affilié && users[affilié]) {
            users[username].entrepriseAffiliee = affilié;
          } else {
            alert("Le compte affilié n'existe pas. Laissez vide ou mettez un compte valide.");
            users[username].entrepriseAffiliee = "";
            inputEntreprise.value = "";
          }
        } else {
          users[username].entrepriseAffiliee = "";
          inputEntreprise.value = "";
        }

        saveUsers();
        updateCurrentUserIfNeeded(username);
        alert(`Utilisateur "${username}" mis à jour !`);
        buildTable(); // Pour mettre à jour les champs disable/enabled
      };
      tdActions.appendChild(btnSave);
      tr.appendChild(tdActions);

      // Désactiver champ entreprise si badge !== entreprise
      selectBadge.onchange = () => {
        if (selectBadge.value === "entreprise") {
          inputEntreprise.disabled = false;
          inputEntreprise.style.backgroundColor = "";
        } else {
          inputEntreprise.disabled = true;
          inputEntreprise.value = "";
          inputEntreprise.style.backgroundColor = "#eee";
        }
      };

      tbody.appendChild(tr);
    }
  }

  function logout() {
    localStorage.removeItem('instaUser');
  }

  buildTable();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Gestion utilisateurs avancée</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 10px;}
    table {width: 100%; border-collapse: collapse; margin-top: 15px;}
    th, td {border: 1px solid #aaa; padding: 8px; text-align: left;}
    th {background-color: #ddd;}
    input[type="text"], select {width: 100%; padding: 5px; box-sizing: border-box;}
    button {margin-top: 10px; padding: 8px 12px; cursor: pointer; background: #0095f6; color: white; border: none; border-radius: 4px; font-weight: bold;}
    button.delete-btn {background-color: #e0245e; margin: 0; padding: 5px 10px;}
    button.delete-btn:hover {background-color: #a3163a;}
    nav a {margin-right: 10px; text-decoration: none; font-weight: bold; color: #333;}
    h2 {margin-top: 40px;}
  </style>
</head>
<body>

<header>
  <h1>Admin - Gestion des utilisateurs</h1>
  <nav>
    <a href="feed.html">Feed</a>
    <a href="profil.html">Profil</a>
    <a href="index.html" onclick="logout()">Déconnexion</a>
  </nav>
</header>

<div id="message"></div>

<!-- Tableau utilisateurs -->
<table id="usersTable">
  <thead>
    <tr>
      <th>Nom d'utilisateur</th>
      <th>Badge</th>
      <th>Entreprise affiliée</th>
      <th>Bio</th>
      <th>Avatar URL</th>
      <th>Bannière URL</th>
      <th>Story</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Utilisateurs listés ici -->
  </tbody>
</table>

<!-- Section gestion posts -->
<h2>Gestion des posts</h2>
<table id="postsTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Utilisateur</th>
      <th>Contenu</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Posts listés ici -->
  </tbody>
</table>

<script>
  // Chargement utilisateurs et session
  let users = JSON.parse(localStorage.getItem('instaUsers')) || {};
  let currentUser = JSON.parse(localStorage.getItem('instaUser'));

  // Posts stockés dans localStorage sous 'instaPosts'
  let posts = JSON.parse(localStorage.getItem('instaPosts')) || [];

  function redirectToIndex() {
    alert("Accès refusé : page admin réservée aux administrateurs.");
    window.location.href = "index.html";
  }

  // Construire tableau utilisateurs
  function buildUsersTable() {
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    for (const username in users) {
      const user = users[username];
      const tr = document.createElement('tr');

      // Nom
      const tdName = document.createElement('td');
      tdName.textContent = username;
      tr.appendChild(tdName);

      // Badge
      const tdBadge = document.createElement('td');
      const selectBadge = document.createElement('select');
      const badges = ["", "certifié", "entreprise", "admin"];
      badges.forEach(b => {
        const option = document.createElement('option');
        option.value = b;
        option.textContent = b === "" ? "(aucun)" : b;
        if (user.badge === b) option.selected = true;
        selectBadge.appendChild(option);
      });
      tdBadge.appendChild(selectBadge);
      tr.appendChild(tdBadge);

      // Entreprise affiliée (seulement si badge entreprise)
      const tdEntreprise = document.createElement('td');
      const inputEntreprise = document.createElement('input');
      inputEntreprise.type = 'text';
      inputEntreprise.placeholder = "Nom compte entreprise affiliée";
      inputEntreprise.value = user.entrepriseAffiliee || "";
      if (user.badge !== "entreprise") {
        inputEntreprise.disabled = true;
        inputEntreprise.style.backgroundColor = "#eee";
      }
      tdEntreprise.appendChild(inputEntreprise);
      tr.appendChild(tdEntreprise);

      // Bio
      const tdBio = document.createElement('td');
      const inputBio = document.createElement('input');
      inputBio.type = 'text';
      inputBio.value = user.bio || "";
      tdBio.appendChild(inputBio);
      tr.appendChild(tdBio);

      // Avatar
      const tdAvatar = document.createElement('td');
      const inputAvatar = document.createElement('input');
      inputAvatar.type = 'text';
      inputAvatar.value = user.avatar || "";
      tdAvatar.appendChild(inputAvatar);
      tr.appendChild(tdAvatar);

      // Bannière
      const tdBanner = document.createElement('td');
      const inputBanner = document.createElement('input');
      inputBanner.type = 'text';
      inputBanner.value = user.banner || "";
      tdBanner.appendChild(inputBanner);
      tr.appendChild(tdBanner);

      // Story
      const tdStory = document.createElement('td');
      const inputStory = document.createElement('input');
      inputStory.type = 'text';
      inputStory.value = user.story || "";
      tdStory.appendChild(inputStory);
      tr.appendChild(tdStory);

      // Actions
      const tdActions = document.createElement('td');
      const btnSave = document.createElement('button');
      btnSave.textContent = "Sauvegarder";
      btnSave.onclick = () => {
        const badgeSelected = selectBadge.value;
        users[username].badge = badgeSelected;
        users[username].bio = inputBio.value.trim();
        users[username].avatar = inputAvatar.value.trim() || "default-avatar.png";
        users[username].banner = inputBanner.value.trim();
        users[username].story = inputStory.value.trim();

        if (badgeSelected === "entreprise") {
          const affilié = inputEntreprise.value.trim();
          if (affilié && users[affilié]) {
            users[username].entrepriseAffiliee = affilié;
          } else {
            alert("Le compte affilié n'existe pas. Laissez vide ou mettez un compte valide.");
            users[username].entrepriseAffiliee = "";
            inputEntreprise.value = "";
          }
        } else {
          users[username].entrepriseAffiliee = "";
          inputEntreprise.value = "";
        }

        saveUsers();
        updateCurrentUserIfNeeded(username);
        alert(`Utilisateur "${username}" mis à jour !`);
        buildUsersTable();
      };
      tdActions.appendChild(btnSave);
      tr.appendChild(tdActions);

      selectBadge.onchange = () => {
        if (selectBadge.value === "entreprise") {
          inputEntreprise.disabled = false;
          inputEntreprise.style.backgroundColor = "";
        } else {
          inputEntreprise.disabled = true;
          inputEntreprise.value = "";
          inputEntreprise.style.backgroundColor = "#eee";
        }
      };

      tbody.appendChild(tr);
    }
  }

  // Construire tableau posts
  function buildPostsTable() {
    const tbody = document.querySelector('#postsTable tbody');
    tbody.innerHTML = '';

    posts.forEach(post => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td');
      tdId.textContent = post.id;
      tr.appendChild(tdId);

      const tdUser = document.createElement('td');
      tdUser.textContent = post.username;
      tr.appendChild(tdUser);

      const tdContent = document.createElement('td');
      tdContent.textContent = post.content;
      tr.appendChild(tdContent);

      const tdActions = document.createElement('td');
      const btnDelete = document.createElement('button');
      btnDelete.textContent = "Supprimer";
      btnDelete.classList.add('delete-btn');
      btnDelete.onclick = () => {
        if(confirm("Voulez-vous vraiment supprimer ce post ?")) {
          posts = posts.filter(p => p.id !== post.id);
          savePosts();
          buildPostsTable();
          alert("Post supprimé !");
        }
      };
      tdActions.appendChild(btnDelete);
      tr.appendChild(tdActions);

      tbody.appendChild(tr);
    });
  }

  function logout() {
    localStorage.removeItem('instaUser');
  }

  buildUsersTable();
  buildPostsTable();

</script>

</body>
</html>
