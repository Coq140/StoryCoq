<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin - Gestion utilisateurs avec badges Twitter</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 10px;}
  table {width: 100%; border-collapse: collapse; margin-top: 15px;}
  th, td {border: 1px solid #aaa; padding: 8px; text-align: left; vertical-align: middle;}
  th {background-color: #ddd;}
  input[type="text"], select {width: 100%; padding: 5px; box-sizing: border-box;}
  button {margin-top: 10px; padding: 8px 12px; cursor: pointer; background: #0095f6; color: white; border: none; border-radius: 4px; font-weight: bold;}
  nav a {margin-right: 10px; text-decoration: none; font-weight: bold; color: #333;}
  .logo-entreprise {
    width: 20px;
    height: 20px;
    vertical-align: middle;
    margin-left: 6px;
    border-radius: 50%;
    border: 1px solid #ccc;
    object-fit: cover;
  }
  /* Badge style Twitter */
  .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    margin-left: 6px;
    vertical-align: middle;
  }
  .badge.certifie {
    background-color: #1DA1F2; /* bleu Twitter */
  }
  .badge.entreprise {
    background-color: #17BF63; /* vert */
  }
  .badge.admin {
    background-color: #E0245E; /* rouge */
  }
  .badge svg {
    width: 12px;
    height: 12px;
    fill: white;
  }
</style>
</head>
<body>

<header>
  <h1>Admin - Gestion des utilisateurs</h1>
  <nav>
    <a href="feed.html">Feed</a>
    <a href="profil.html">Profil</a>
    <a href="index.html" onclick="logout()">Déconnexion</a>
  </nav>
</header>

<div id="message"></div>

<table id="usersTable">
  <thead>
    <tr>
      <th>Nom d'utilisateur</th>
      <th>Badge</th>
      <th>Entreprise affiliée</th>
      <th>Bio</th>
      <th>Avatar URL</th>
      <th>Bannière URL</th>
      <th>Story</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- Utilisateurs listés ici -->
  </tbody>
</table>

<script>
  let users = JSON.parse(localStorage.getItem('instaUsers')) || {};
  let currentUser = JSON.parse(localStorage.getItem('instaUser'));

  if (!currentUser || currentUser.badge !== "admin") {
    alert("Accès refusé : page admin réservée aux administrateurs.");
    window.location.href = "index.html";
  }

  function saveUsers() {
    localStorage.setItem('instaUsers', JSON.stringify(users));
  }

  function updateCurrentUserIfNeeded(username) {
    if (currentUser && currentUser.name === username) {
      currentUser = { name: username, ...users[username] };
      localStorage.setItem('instaUser', JSON.stringify(currentUser));
    }
  }

  // Fonction pour retourner le SVG du badge selon type
  function getBadgeSVG(type) {
    switch(type) {
      case 'certifie':
        return `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M22.25 12l-5.33 4.44.89 6.1-5.33-3.78-5.33 3.78.89-6.1L1.75 12l5.33-4.44-.89-6.1 5.33 3.78 5.33-3.78-.89 6.1z"/></svg>`;
      case 'entreprise':
        return `<svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10" /></svg>`;
      case 'admin':
        return `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2L15 8l6 1-4 4 1 6-5-3-5 3 1-6-4-4 6-1z"/></svg>`;
      default:
        return "";
    }
  }

  function buildTable() {
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML = '';

    for (const username in users) {
      const user = users[username];
      const tr = document.createElement('tr');

      // Nom d'utilisateur + logo entreprise affiliée
      const tdName = document.createElement('td');
      tdName.textContent = username;

      // Logo entreprise affiliée (avatar)
      if (user.entrepriseAffiliee && users[user.entrepriseAffiliee]) {
        const logoEntreprise = document.createElement('img');
        logoEntreprise.src = users[user.entrepriseAffiliee].avatar || "default-avatar.png";
        logoEntreprise.alt = user.entrepriseAffiliee;
        logoEntreprise.className = "logo-entreprise";
        logoEntreprise.title = `Affilié à ${user.entrepriseAffiliee}`;
        tdName.appendChild(document.createTextNode(" "));
        tdName.appendChild(logoEntreprise);
      }

      // Badge style Twitter à côté du nom d’utilisateur
      if (user.badge) {
        const badgeSpan = document.createElement('span');
        badgeSpan.className = `badge ${user.badge}`;
        badgeSpan.title = user.badge.charAt(0).toUpperCase() + user.badge.slice(1);
        badgeSpan.innerHTML = getBadgeSVG(user.badge);
        tdName.appendChild(badgeSpan);
      }

      tr.appendChild(tdName);

      // Badge (select)
      const tdBadge = document.createElement('td');
      const selectBadge = document.createElement('select');
      const badges = ["", "certifie", "entreprise", "admin"];
      badges.forEach(b => {
        const option = document.createElement('option');
        option.value = b;
        option.textContent = b === "" ? "(aucun)" : b;
        if (user.badge === b) option.selected = true;
        selectBadge.appendChild(option);
      });
      tdBadge.appendChild(selectBadge);
      tr.appendChild(tdBadge);

      // Entreprise affiliée (input activé seulement si badge = entreprise)
      const tdEntreprise = document.createElement('td');
      const inputEntreprise = document.createElement('input');
      inputEntreprise.type = 'text';
      inputEntreprise.placeholder = "Nom compte affilié";
      inputEntreprise.value = user.entrepriseAffiliee || "";
      if (user.badge !== "entreprise") {
        inputEntreprise.disabled = true;
        inputEntreprise.style.backgroundColor = "#eee";
      }
      tdEntreprise.appendChild(inputEntreprise);
      tr.appendChild(tdEntreprise);

      // Bio
      const tdBio = document.createElement('td');
      const inputBio = document.createElement('input');
      inputBio.type = 'text';
      inputBio.value = user.bio || "";
      tdBio.appendChild(inputBio);
      tr.appendChild(tdBio);

      // Avatar URL
      const tdAvatar = document.createElement('td');
      const inputAvatar = document.createElement('input');
      inputAvatar.type = 'text';
      inputAvatar.value = user.avatar || "";
      tdAvatar.appendChild(inputAvatar);
      tr.appendChild(tdAvatar);

      // Bannière URL
      const tdBanner = document.createElement('td');
      const inputBanner = document.createElement('input');
      inputBanner.type = 'text';
      inputBanner.value = user.banner || "";
      tdBanner.appendChild(inputBanner);
      tr.appendChild(tdBanner);

      // Story
      const tdStory = document.createElement('td');
      const inputStory = document.createElement('input');
      inputStory.type = 'text';
      inputStory.value = user.story || "";
      tdStory.appendChild(inputStory);
      tr.appendChild(tdStory);

      // Actions
      const tdActions = document.createElement('td');
      const btnSave = document.createElement('button');
      btnSave.textContent = "Sauvegarder";
      btnSave.onclick = () => {
        const badgeSelected = selectBadge.value;
        users[username].badge = badgeSelected;
        users[username].bio = inputBio.value.trim();
        users[username].avatar = inputAvatar.value.trim() || "default-avatar.png";
        users[username].banner = inputBanner.value.trim();
        users[username].story = inputStory.value.trim();

        // Gestion entreprise affiliée
        if (badgeSelected === "entreprise") {
          const affilié = inputEntreprise.value.trim();
          if (affilié && users[affilié]) {
            users[username].entrepriseAffiliee = affilié;
          } else {
            alert("Le compte affilié n'existe pas. Laissez vide ou mettez un compte valide.");
            users[username].entrepriseAffiliee = "";
            inputEntreprise.value = "";
          }
        } else {
          users[username].entrepriseAffiliee = "";
          inputEntreprise.value = "";
        }

        saveUsers();
        updateCurrentUserIfNeeded(username);
        alert(`Utilisateur "${username}" mis à jour !`);
        buildTable();
      };
      tdActions.appendChild(btnSave);

      if (currentUser.badge === "admin" && username !== currentUser.name) {
        const btnDelete = document.createElement('button');
        btnDelete.textContent = "Supprimer";
        btnDelete.style.marginLeft = "8px";
        btnDelete.onclick = () => {
          if (confirm(`Supprimer l'utilisateur "${username}" ?`)) {
            delete users[username];
            saveUsers();
            buildTable();
          }
        };
        tdActions.appendChild(btnDelete);
      }

      tr.appendChild(tdActions);

      // Activation/désactivation input affiliation selon badge sélectionné
      selectBadge.onchange = () => {
        if (selectBadge.value === "entreprise") {
          inputEntreprise.disabled = false;
          inputEntreprise.style.backgroundColor = "";
        } else {
          inputEntreprise.disabled = true;
          inputEntreprise.value = "";
          inputEntreprise.style.backgroundColor = "#eee";
        }
      };

      tbody.appendChild(tr);
    }
  }

  function logout() {
    localStorage.removeItem('instaUser');
  }

  buildTable();
</script>

</body>
</html>
